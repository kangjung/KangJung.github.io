<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë°ì´í„°ë¶„ì„ ë˜ì „</title>
  <style>
    body { font-family: 'Pretendard','Arial',sans-serif; background: #202b38; color: #212347; margin: 0; }
    .container { max-width: 460px; margin: 40px auto 40px; background: white; border-radius: 16px; box-shadow: 0 4px 20px #0008; padding: 30px; }
    h2 { color: #44318d; margin-top: 0; text-align: center; }
    .dungeons { display: flex; gap: 12px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
    .dungeon-card {
      border: 2px solid #bc6ff1;
      border-radius: 11px;
      background: #f4f0ff;
      width: 130px;
      text-align: center;
      padding: 15px 10px 10px;
      cursor: pointer;
      position: relative;
      user-select: none;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    .dungeon-card.locked {
      filter: grayscale(1) opacity(0.7);
      cursor: not-allowed;
    }
    .dungeon-card.clear::after {
      content: 'âœ“';
      position: absolute;
      top: 8px;
      right: 12px;
      color: #19b08c;
      font-size: 1.2em;
      font-weight: bold;
    }
    .dungeon-card.selected {
      background: #b8c0ff;
    }
    .concepts {
      margin: 10px 0 15px;
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 12px;
      background: #fefcff;
    }
    .concept {
      background: #efe5ff;
      padding: 10px 14px;
      margin: 8px 0;
      border-radius: 8px;
      font-size: 0.95em;
      line-height: 1.3;
    }
    #battle, #score, #concepts, #restart, #backBtn {
      display: none;
    }
    .choice-btn {
      width: 100%;
      margin: 10px 0;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: #ece4f3;
      cursor: pointer;
      font-size: 1em;
      user-select: none;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    .choice-btn:hover:not(:disabled) {
      background-color: #b7aaff;
    }
    .choice-btn.correct {
      background: #19b08c;
      color: white;
    }
    .choice-btn.incorrect {
      background: #e84545;
      color: white;
    }
    .status-bar {
      text-align: center;
      margin: 12px 0;
      font-weight: bold;
      font-size: 1.1em;
    }
    .hp {
      color: #cc287a;
      font-weight: 700;
    }
    .danger {
      color: #e84545;
      font-weight: 700;
    }
    #restart, #backBtn {
      margin-top: 20px;
      background: #44318d;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 0;
      width: 100%;
      font-size: 1.1em;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    #restart:hover, #backBtn:hover {
      background-color: #361a92;
    }@media (max-width: 480px) {
      body {
        font-size: 16px; /* ê¸°ë³¸ í°íŠ¸ í¬ê¸° í‚¤ì›€ */
      }
      .container {
        max-width: 100vw; /* í™”ë©´ ê°€ë“ ì±„ì›€ */
        margin: 10px 5px;
        padding: 20px 15px;
        border-radius: 12px;
      }
      .dungeons {
        gap: 10px;
        justify-content: space-around;
      }
      .dungeon-card {
        width: 120px;  /* ì¹´ë“œ í¬ê¸° í‚¤ì›€ */
        padding: 14px 10px 12px;
        font-size: 1em;
        border-radius: 12px;
      }
      .concepts {
        max-height: 350px;
        padding: 12px 15px;
      }
      .concept {
        font-size: 1em;
        padding: 10px 12px;
      }
      .choice-btn {
        padding: 14px;
        font-size: 1.05em;
      }
      .status-bar {
        font-size: 1.1em;
      }
      #restart, #backBtn {
        font-size: 1.1em;
        padding: 14px 0;
        border-radius: 10px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h2>ğŸ—¡ï¸ ë°ì´í„°ë¶„ì„ ë˜ì „</h2>
  <div id="dungeonSel">
    <div class="dungeons" id="dungeon-list"></div>
  </div>
  <div id="concepts">
    <h4>ğŸ“ í•µì‹¬ ê°œë…</h4>
    <div class="concepts" id="concept-list"></div>
    <button id="enter-dungeon" class="choice-btn" disabled>ë˜ì „ ì…ì¥</button>
    <button id="backBtn">â† ë˜ì „ ì„ íƒ í™”ë©´ìœ¼ë¡œ</button>
  </div>
  <div id="battle">
    <div class="status-bar">í”Œë ˆì´ì–´ HP: <span id="player-hp"></span> | ì  HP: <span id="monster-hp"></span></div>
    <div id="quiz">
      <div class="question" id="question"></div>
      <div class="choices" id="choices"></div>
    </div>
  </div>
  <div id="score" style="text-align:center; font-size:1.3em; margin-top: 20px; font-weight: 700;"></div>
  <button id="restart" style="display:none;">ì²˜ìŒìœ¼ë¡œ ê°€ê¸°</button>
</div>

<script>
  // ë‚´ë¶€ JSON ë°ì´í„° ì§ì ‘ ì„ ì–¸ (ì´ì „ ë‹µë³€ ê¸°ë°˜)
  let jsonData = null;
  const clearStateKey = 'dataanalysis_dungeon_clear';
  let clearState = JSON.parse(localStorage.getItem(clearStateKey) || '{}');

  let currIdx = -1;
  let dungeonData = null;

  let playerHp = 3, monsterHp = 3, quizOrder = [], currentQ = 0, gameEnd = false;

  const dungeonListEl = document.getElementById('dungeon-list');
  const conceptListEl = document.getElementById('concept-list');
  const conceptsDiv = document.getElementById('concepts');
  const dungeonSelDiv = document.getElementById('dungeonSel');
  const battleDiv = document.getElementById('battle');
  const questionEl = document.getElementById('question');
  const choicesEl = document.getElementById('choices');
  const playerHpEl = document.getElementById('player-hp');
  const monsterHpEl = document.getElementById('monster-hp');
  const scoreEl = document.getElementById('score');
  const restartBtn = document.getElementById('restart');
  const enterDungeonBtn = document.getElementById('enter-dungeon');
  const backBtn = document.getElementById('backBtn');

  function shuffle(array) {
    return array.map(v => [Math.random(), v])
      .sort((a,b) => a[0] - b[0])
      .map(v => v[1]);
  }

  // JSON ë°ì´í„° fetch
  async function loadData() {
    try {
      const response = await fetch('/assets/json/dungeons.json'); // ì‹¤ì œ json ê²½ë¡œë¡œ ìˆ˜ì •
      if(!response.ok) throw new Error('JSON ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      jsonData = await response.json();
      renderDungeons();
    } catch(e) {
      alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: '+e.message);
    }
  }

  // ë˜ì „ ëª©ë¡ ë Œë”ë§
  function renderDungeons() {
    dungeonListEl.innerHTML = "";
    jsonData.dungeons.forEach((d, i) => {
      const btn = document.createElement('div');
      btn.className = 'dungeon-card';
      if(clearState[d.id]) btn.classList.add('clear');
      if(i > 0 && !clearState[jsonData.dungeons[i-1].id]) btn.classList.add('locked');
      btn.textContent = d.chapter;
      btn.onclick = () => {
        if(btn.classList.contains('locked')) return;
        currIdx = i;
        selectDungeon();
      };
      dungeonListEl.appendChild(btn);
    });
    dungeonSelDiv.style.display = "block";
    conceptsDiv.style.display = "none";
    battleDiv.style.display = "none";
    scoreEl.style.display = "none";
    restartBtn.style.display = "none";
    backBtn.style.display = "none";
  }

  // ë˜ì „ ì„ íƒ í›„ í•µì‹¬ ê°œë… í‘œì‹œ
  function selectDungeon() {
    if(currIdx === -1) return;
    dungeonData = jsonData.dungeons[currIdx];
    conceptListEl.innerHTML = "";
    dungeonData.concepts.forEach(c => {
      const el = document.createElement('div');
      el.className = 'concept';
      el.innerHTML = `<b>${c.title}</b><br/>${c.content}`;
      conceptListEl.appendChild(el);
    });
    dungeonSelDiv.style.display = "none";
    conceptsDiv.style.display = "block";
    battleDiv.style.display = "none";
    scoreEl.style.display = "none";
    restartBtn.style.display = "none";
    backBtn.style.display = "block";

    enterDungeonBtn.disabled = false; // ì…ì¥ í™œì„±í™”
  }

  enterDungeonBtn.onclick = () => {
    startBattle();
  };

  backBtn.onclick = () => {
    renderDungeons();
    currIdx = -1;
    enterDungeonBtn.disabled = true;
  };

  function startBattle() {
    playerHp = 3;
    monsterHp = 3;
    currentQ = 0;
    quizOrder = shuffle([...dungeonData.quiz]);
    gameEnd = false;
    conceptsDiv.style.display = "none";
    battleDiv.style.display = "block";
    scoreEl.style.display = "none";
    restartBtn.style.display = "none";
    backBtn.style.display = "none";
    updateStatus();
    showQuestion();
  }

  function updateStatus() {
    playerHpEl.textContent = 'â¤'.repeat(playerHp) + ` (${playerHp})`;
    monsterHpEl.textContent = 'ğŸ‘¾'.repeat(monsterHp) + ` (${monsterHp})`;
  }

  function showQuestion() {
    if(gameEnd) return;
    let q = quizOrder[currentQ];
    questionEl.textContent = q.question;
    choicesEl.innerHTML = "";
    let shuffledChoices = shuffle([...q.choices]);
    shuffledChoices.forEach(choice => {
      const btn = document.createElement('button');
      btn.textContent = choice;
      btn.className = 'choice-btn';
      btn.onclick = () => selectAnswer(btn, choice, q.answer);
      choicesEl.appendChild(btn);
    });
  }

  function selectAnswer(btn, choice, answer) {
    const btns = document.querySelectorAll('.choice-btn');
    btns.forEach(b => b.disabled = true);
    if(choice === answer) {
      btn.classList.add('correct');
      monsterHp--;
    } else {
      btn.classList.add('incorrect');
      btns.forEach(b => {
        if(b.textContent === answer) {
          b.classList.add('correct');
        }
      });
      playerHp--;
    }
    updateStatus();
    setTimeout(() => {
      currentQ++;
      if(playerHp <= 0 || monsterHp <= 0 || currentQ >= quizOrder.length) {
        endGame();
      } else {
        showQuestion();
      }
    }, 900);
  }

  function endGame() {
    gameEnd = true;
    questionEl.textContent = "";
    choicesEl.innerHTML = "";
    battleDiv.style.display = "block";
    scoreEl.style.display = "block";
    restartBtn.style.display = "block";
    backBtn.style.display = "block";

    if(playerHp > 0 && monsterHp <= 0) {
      scoreEl.innerHTML = "ğŸ‰ <b>ìŠ¹ë¦¬! ë˜ì „ í´ë¦¬ì–´</b>";
      clearState[dungeonData.id] = true;
      localStorage.setItem(clearStateKey, JSON.stringify(clearState));
    } else if(playerHp <= 0) {
      scoreEl.innerHTML = "âŒ <b>íŒ¨ë°°</b> í”Œë ˆì´ì–´ê°€ ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤.";
    } else {
      scoreEl.innerHTML = "âš”ï¸ <b>í€´ì¦ˆ ì¢…ë£Œ</b>";
    }
  }

  restartBtn.onclick = () => {
    renderDungeons();
    currIdx = -1;
    enterDungeonBtn.disabled = true;
  };

  window.onload = () => {

    loadData();
    renderDungeons();
  };
</script>
</body>
</html>
